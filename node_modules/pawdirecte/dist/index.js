"use strict";var e=require("@literate.ink/utilities"),t=require("js-base64"),a=class{status;token;access_token=null;message=null;data;constructor(t){this.token=e.getHeaderFromResponse(t,"x-token");const a=e.getHeaderFromResponse(t,"content-type");if(a?.startsWith("application/json")||((n=t.content).startsWith("[")||n.startsWith("{"))&&(n.endsWith("]")||n.endsWith("}"))){const e=JSON.parse(t.content);this.status=e.code,this.data=e.data,this.message=e.message,"token"in e&&(this.token=e.token)}else this.status=Number.parseInt(e.getHeaderFromResponse(t,"x-code"),10);var n}},n=class{url;headers;method;content;constructor(e){this.url=new URL(`https://api.ecoledirecte.com/v3${e}`),this.headers={"User-Agent":"Android EDMOBILE v7.0.1"}}setToken(e){return this.headers["X-Token"]=e,this}addVersionURL(){return this.url.searchParams.set("v","7.0.1"),this}setFormData(e){return this.method="POST",this.content=`data=${JSON.stringify(e)}`,this.headers["Content-Type"]="application/x-www-form-urlencoded",this}async send(t=e.defaultFetcher){const n=await t(this);return new a(n)}async sendRaw(t=e.defaultFetcher){return await t(this)}},s=class extends Error{constructor(){super("Bad credentials, no token found in response"),this.name="BadCredentials"}},o=class extends Error{constructor(){super("Bad double auth response"),this.name="BadDoubleAuth"}},r=class extends Error{constructor(){super("Double authentication required"),this.name="DoubleAuthRequired"}},i=class extends Error{constructor(){super("Invalid version, please open an issue at the 'LiterateInk/Pawdirecte' GitHub repository."),this.name="InvalidVersion"}},d=class extends Error{constructor(){super("Session token is required to do this action"),this.name="SessionTokenRequired"}},c=class extends Error{constructor(e,t){super(`Expected a value from the enum '${e}', but got '${t}'`),this.name="UnknownEnumValue"}},u={Student:"E"},l=(e=>(e.Cloud="CLOUD",e.Homework="FICHIER_CDT",e.Attachement="PIECE_JOINTE",e.CantineMenu="FICHIER_MENU_RESTAURATION",e.Administrative="ADMINISTRATIF",e.Other="",e))(l||{}),m={Error:-1,Grade:0,Absent:1,Exempted:2,NotGraded:3,Waiting:4},p=e=>({id:e.id,studentId:e.idEleve,studentName:e.nomEleve,reason:e.motif,date:new Date(e.date),dateOfEvent:new Date(e.dateDeroulement),label:e.libelle,teacher:e.par,comment:e.commentaire,justified:e.justifie,justificationType:e.typeJustification,onlineJustification:e.justifieEd,subjectName:e.matiere,todo:e.aFaire,kind:e.typeElement,displayDate:""!==e.displayDate?e.displayDate:e.dateDeroulement.toLowerCase().replace("<br>"," ").replace("déroulement prévu ","")}),w=e=>{const t={monday:{breakfast:!1,lunch:"1"===e.params.repasmidi_1,diner:"1"===e.params.repassoir_1},tuesday:{breakfast:!1,lunch:"1"===e.params.repasmidi_2,diner:"1"===e.params.repassoir_2},wednesay:{breakfast:!1,lunch:"1"===e.params.repasmidi_3,diner:"1"===e.params.repassoir_3},thursday:{breakfast:!1,lunch:"1"===e.params.repasmidi_4,diner:"1"===e.params.repassoir_4},friday:{breakfast:!1,lunch:"1"===e.params.repasmidi_5,diner:"1"===e.params.repassoir_5},saturday:{breakfast:!1,lunch:"1"===e.params.repasmidi_6,diner:"1"===e.params.repassoir_6},sunday:{breakfast:!1,lunch:"1"===e.params.repasmidi_7,diner:"1"===e.params.repassoir_7}};return{badge:e.badge,diet:e.params.regime,meals:t}},h=e=>({id:e.id,name:e.libelle,date:new Date(e.date),kind:e.type,signatureRequired:e.signatureDemandee??!1,signature:e.signature??void 0}),k=(e,t,a="")=>{const n=`/telechargement.awp?verbe=get&fichierId=${t}`;let s;switch(e){case"ADMINISTRATIF":s=n+a!==""?`archive=true&anneeArchive=${a}`:"";break;case"PIECE_JOINTE":s=n+a!==""?`anneeMessages=${a}`:"";break;default:s=`${n}&leTypeDeFichier=${e}`}return s},f=e=>{if(!e)return{kind:m.Error,points:0};switch(e.trim()){case"Disp":return{kind:m.Exempted,points:0};case"Abs":return{kind:m.Absent,points:0};case"NE":return{kind:m.NotGraded,points:0};case"EA":return{kind:m.Waiting,points:0};default:try{return{kind:m.Grade,points:Number(e.replaceAll(",","."))}}catch{return{kind:m.Error,points:0}}}},b=e=>({id:e.idCompetence,name:e.libelleCompetence,description:e.descriptif,value:Number(e.valeur)}),D=e=>({comment:e.devoir,average:f(e.moyenneClasse),isOptional:e.valeurisee,skills:e.elementsProgramme.map(b),coefficient:Number(e.coef),date:new Date(e.date),examType:e.typeDevoir,max:f(e.maxClasse),min:f(e.minClasse),outOf:e.noteSur.replaceAll(",","."),period:{id:e.codePeriode,name:""},subject:{id:e.codeMatiere,subSubjectId:e.codeSousMatiere,name:e.libelleMatiere},subjectFilePath:e.uncSujet,correctionFilePath:e.uncCorrige,value:f(e.valeur)}),g=e=>{const t={},a=e.parametrage.moyenneSur||20,n=e.parametrage.moyenneGenerale,s=e.parametrage.notePeriodeAnnuelle;for(const o of e.periodes)if(!1!==s||!0!==o.yearly){const e=o.ensembleMatieres.disciplines;t[o.idPeriode]={classAverage:f(o.ensembleMatieres.moyenneClasse),overallAverage:n?f(o.ensembleMatieres.moyenneGenerale):y(o),subjects:[]};for(const n of e)t[o.idPeriode].subjects.push({name:n.discipline,id:n.codeMatiere,childSubjectId:n.codeSousMatiere,isChildSubject:n.sousMatiere,color:"string",coefficient:Number(n.coef),classAverage:f(n.moyenneClasse?.replace(",",".")),maxAverage:f(n.moyenneMax?.replace(",",".")),minAverage:f(n.moyenneMin?.replace(",",".")),studentAverage:f(n.moyenne?.replace(",",".")),outOf:f(a.toString())})}return t};function y(e){let t=0,a=0;const n=e.ensembleMatieres.disciplines;for(const e of n)if(""!==e.moyenne){const n=f(e.moyenne?.replace(",",".")).points,s=0===e.coef?1:e.coef;t+=s,a+=n*s}return f((a/t).toString())}var v=e=>({id:e.idPeriode,startDate:new Date(e.dateDebut),endDate:new Date(e.dateFin),isEnded:e.cloture,councilDate:new Date(e.dateConseil),councilClassroom:e.salleConseil,councilStartHour:e.heureConseil,councilEndHour:e.heureFinConseil,isMockExam:e.examenBlanc,yearly:e.annuel,name:e.periode}),E=e=>{const[t,a,n]=e.split("/").map(Number);return new Date(n,a-1,t)},x=e=>({authorName:e.auteur.nom,creationDate:E(e.dateCreation),startDate:E(e.dateDebut),endDate:E(e.dateFin),id:e.id,content:t.decode(e.contenu),colorName:e.type}),R=e=>({id:e.id,subject:e.matiere,teacher:e.nomProf,exam:e.interrogation,done:e.aFaire.effectue,content:t.decode(e.aFaire.contenu),createdDate:new Date(e.aFaire.donneLe),attachments:e.aFaire.documents.map(h)}),A=e=>({id:e.idDevoir,subject:e.matiere,isExam:e.interrogation,done:e.effectue,createdDate:new Date(e.donneLe)});var T=e=>({id:e.id,type:e.mtype,read:e.read,subject:e.subject,date:new Date(e.date),sender:`${e.from.prenom} ${e.from.nom}`,canAnswer:e.canAnswer,content:e.content,files:e.files.map((e=>({id:e.id,name:e.libelle,type:e.type})))}),C=e=>({title:e.titre,description:e.soustitre,content:e.contenu,elementID:e.idElement,elementKind:e.typeElement,date:new Date(e.date)}),F=e=>({id:e.id,color:e.color,startDate:new Date(e.start_date),endDate:new Date(e.end_date),subjectName:e.matiere,subjectShortName:e.codeMatiere,room:e.salle,teacher:e.prof,kind:e.typeCours,cancelled:e.isAnnule,updated:e.isModifie,notes:e.text}),N=e=>({id:e.id,title:e.titre,description:e.description,summary:t.decode(e.resume),cloud:e.cloud,discussion:e.discussion,agenda:e.agenda,isPublic:e.public,isOpen:e.ouvert,kind:e.type,isMember:e.estMembre,isAdmin:e.estAdmin,teacherRooms:e.salleDesProfs,createdBy:e.creePar,permissions:e.droitUtilisateur,nbMembers:e.nbMembres,colorEventAgenda:e.couleurEvenementAgenda,createdAt:e.creeLe}),I=e=>{if(e=String(e),!Object.values(u).includes(e))throw new c("AccountKind",e);return e},S=e=>{const t=void 0!==e.profile.sexe&&null!==e.profile.sexe?e.profile.sexe:"Mme"===e.civilite?"F":"M";return{loginID:e.idLogin,id:e.id,userID:e.uid,username:e.identifiant,kind:I(e.typeCompte),ogecID:e.codeOgec,main:e.main,lastConnection:e.lastConnexion,firstName:e.prenom,lastName:e.nom,email:e.email,phone:e.profile.telPortable,schoolName:e.nomEtablissement,schoolUAI:e.profile.rneEtablissement,schoolLogoPath:e.logoEtablissement,schoolAgendaColor:e.couleurAgendaEtablissement,access_token:e.accessToken,socket_token:e.socketToken,gender:t,profilePictureURL:e.profile.photo,modules:e.modules,currentSchoolCycle:e.anneeScolaireCourante,class:{short:e.profile.classe.code,long:e.profile.classe.libelle}}},L=e=>e?{cn:e.name,cv:e.value}:void 0,M=async(t,a=null)=>{let s,o;{const t=new n("/login.awp?gtk=1").addVersionURL(),a=await t.sendRaw();o=e.getCookiesFromResponse(a);for(const e of o){const[t,a]=e.split("=");"GTK"===t&&(s=a)}if(!s)throw new Error("GTK cookie not found in response")}const r=new n("/login.awp").addVersionURL().setFormData(t);return r.headers["X-GTK"]=s,r.headers.Cookie=o.join("; "),a&&r.setToken(a),r},P=async(e,t)=>{const a=await t.send(e.fetcher);switch(e.token=a.token,a.status){case 505:throw new s;case 517:throw new i;case 250:throw new r}return a.data.accounts.map(S)};exports.AccountKind=u,exports.AttendanceItemKind={PUNITION:"Punition",RETARD:"Retard",ABSENCE:"Absence",DISPENSE:"Dispense"},exports.BadCredentials=s,exports.BadDoubleAuth=o,exports.DocumentKind={Grades:"Note",Document:"Doc",SchoolLife:"Viesco",Invoice:"Fac",Registration:"Inscr",Textbook:"FICHIER_CDT",Other:""},exports.DoubleAuthRequired=r,exports.FileKind=l,exports.GradeKind=m,exports.InvalidVersion=i,exports.ReservationMeals={breakfast:"breakfast",lunch:"lunch",diner:"diner"},exports.ReservationWeekdays={monday:"monday",tuesday:"tuesday",wednesay:"wednesday",thursday:"thursday",friday:"friday",saturday:"saturday",sunday:"sunday"},exports.SessionTokenRequired=d,exports.TimelineItemKind={Note:"Note",VieScolaire:"VieScolaire",ReunionPP:"ReunionPP",ReunionPPFamille:"ReunionPPFamille",Actualite:"Actualite",Messagerie:"Messagerie",DocumentFamille:"DocumentFamille",Document:"Document"},exports.TimetableItemKind={COURS:"COURS",PERMANENCE:"PERMANENCE",CONGE:"CONGE",EVENEMENT:"EVENEMENT",SANCTION:"SANCTION"},exports.UnknownEnumValue=c,exports.WorkspaceItemKind={LIBRE:"LIBRE"},exports.accountEdforms=async(e,t)=>{if(!e.token)throw new d;const a=new n("/edforms.awp?verbe=list").addVersionURL().setToken(e.token).setFormData({idEntity:t.id,typeEntity:t.kind}),s=await a.send(e.fetcher);return e.token=s.token,s.data},exports.buildPawdirecteFileDownloadUrl=k,exports.checkDoubleAuth=async(e,a)=>{if(!e.token)throw new d;const s=new n("/connexion/doubleauth.awp?verbe=post").addVersionURL().setToken(e.token).setFormData({choix:t.encode(a)}),r=await s.send(e.fetcher);return e.token=r.token,e.double_auth=(e=>{if(null===e)throw new o;return{name:e.cn,value:e.cv}})(r.data),!0},exports.getFile=async(e,t,a,s="")=>{if(!e.token)throw new d;const o=k(t,a,s);return new n(o).addVersionURL().setFormData({forceDownload:0}).setToken(e.token).sendRaw(e.fetcher)},exports.initDoubleAuth=async e=>{if(!e.token)throw new d;const a=new n("/connexion/doubleauth.awp?verbe=get").addVersionURL().setToken(e.token).setFormData({}),o=await a.send(e.fetcher);if(!o.token)throw new s;return e.token=o.token,r=o.data,{question:t.decode(r.question),answers:r.propositions.map(t.decode)};var r},exports.login=async(e,t)=>{const a=L(e.double_auth),n=await M({...a,fa:a&&[a],identifiant:e.username,uuid:e.device_uuid,isReLogin:!1,sesouvenirdemoi:!0,motdepasse:encodeURIComponent(t)},e.token);return P(e,n)},exports.readMessage=async(e,a,s)=>{if(!e.token)throw new d;const o=new n(`/eleves/${a.id}/messages/${s}.awp?verbe=get&mode=destinataire`).addVersionURL().setToken(e.token).setFormData({}),r=await o.send(e.fetcher);return e.token=r.token,{id:r.data.id,type:r.data.mtype,date:new Date(r.data.date),read:r.data.read,canAnswer:r.data.canAnswer,subject:r.data.subject,content:t.decode(r.data.content),sender:`${r.data.from.prenom} ${r.data.from.nom}`,files:r.data.files.map((e=>({id:e.id,name:e.libelle,type:e.type})))}},exports.refresh=async(e,t)=>{if(!e.token)throw new d;const a=await M({fa:[L(e.double_auth)],identifiant:e.username,uuid:e.device_uuid,isReLogin:!0,motdepasse:"???",typeCompte:t,accesstoken:e.accessToken},e.token);return P(e,a)},exports.setAccessToken=(e,t)=>{e.accessToken=t.access_token},exports.setHomeworkState=async(e,t,a,s)=>{if(!e.token)throw new d;const o=new n(`/Eleves/${t.id}/cahierdetexte.awp?verbe=put`).addVersionURL().setToken(e.token).setFormData({idDevoirsEffectues:[s?a:null],idDevoirsNonEffectues:[s?null:a]});await o.send(e.fetcher)},exports.studentAttendance=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/eleves/${t.id}/viescolaire.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);e.token=s.token;const o=s.data.sanctionsEncouragements,r=s.data.absencesRetards,i=s.data.dispenses;return{punishments:o.map(p),absences:r.map(p),exemptions:i.map(p)}},exports.studentCantine=async e=>{const t=e.modules.find((e=>"RESERVATIONS"===e.code)),a=e.modules.find((e=>"CANTINE_BARCODE"===e.code));return{reservation:t.enable??w(t),barcode:a.enable??(n=a,{badgeNumber:n.params.numeroBadge})};var n},exports.studentComingHomeworks=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/Eleves/${t.id}/cahierdetexte.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);return e.token=s.token,Object.keys(s.data).map((e=>({date:new Date(e),homeworks:s.data[e].map(A)})))},exports.studentDocuments=async(e,t="")=>{if(!e.token)throw new d;const a=new n(`/elevesDocuments.awp?verbe=get&archive=${t}`).addVersionURL().setFormData({forceDownload:0}).setToken(e.token),s=await a.send(e.fetcher);return[...s.data.factures,...s.data.notes,...s.data.viescolaire,...s.data.administratifs,...s.data.inscriptions].map(h)},exports.studentGrades=async(e,t,a)=>{if(!e.token)throw new d;const s=new n(`/eleves/${t.id}/notes.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({anneeScolaire:a}),o=await s.send(e.fetcher);return e.token=o.token,{grades:o.data.notes?.map(D),periods:o.data.periodes?.map(v).filter((e=>!(!1===o.data.parametrage.notePeriodeAnnuelle&&!0===e.yearly))),overview:g(o.data)}},exports.studentHomepageTimeline=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/E/${t.id}/timelineAccueilCommun.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);return e.token=s.token,s.data.postits.map(x)},exports.studentHomeworks=async(e,a,s)=>{if(!e.token)throw new d;const o=new n(`/Eleves/${a.id}/cahierdetexte/${s}.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),r=await o.send(e.fetcher);e.token=r.token;const i=r.data?.matieres.filter((e=>e.aFaire)).map(R),c=r.data?.matieres.map((e=>function(e,a){return{date:a,id:e.id,subject:e.matiere,teacher:e.nomProf,content:t.decode(e.contenuDeSeance?.contenu??""),attachments:e.contenuDeSeance?.documents?.map(h)??[]}}(e,new Date(s)))).filter((e=>e.attachments.length>0||""!==e.content));return{homeworks:i,subjects:c}},exports.studentReceivedMessages=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/eleves/${t.id}/messages.awp?verbe=get&getAll=1`).addVersionURL().setToken(e.token).setFormData({anneeMessages:`${(new Date).getFullYear()}-${(new Date).getFullYear()+1}`}),s=await a.send(e.fetcher);return e.token=s.token,{canReply:s.data.parametrage.destAdmin||s.data.parametrage.destEleve||s.data.parametrage.destEspTravail||s.data.parametrage.destFamille||s.data.parametrage.destProf,chats:s.data.messages.received.map(T).sort(((e,t)=>e.date<t.date?1:e.date>t.date?-1:0))}},exports.studentTimeline=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/eleves/${t.id}/timeline.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);return e.token=s.token,s.data.map(C)},exports.studentTimetable=async(e,t,a,s=a)=>{if(!e.token)throw new d;const o=new n(`/E/${t.id}/emploidutemps.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({dateDebut:a.toLocaleDateString("fr-CA"),dateFin:s.toLocaleDateString("fr-CA"),avecTrous:!1}),r=await o.send(e.fetcher);return e.token=r.token,r.data.map(F).sort(((e,t)=>new Date(e.startDate).getTime()>new Date(t.startDate).getTime()))},exports.studentVisios=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/eleves/${t.id}/visios.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);return e.token=s.token,s.data},exports.studentWorkspace=async(e,t)=>{if(!e.token)throw new d;const a=new n(`/E/${t.id}/espacestravail.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),s=await a.send(e.fetcher);return e.token=s.token,s.data?.map(N)??[]};//# sourceMappingURL=index.js.map