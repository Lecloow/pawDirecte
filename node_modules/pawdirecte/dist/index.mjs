import{defaultFetcher as e,getCookiesFromResponse as t,getHeaderFromResponse as a}from"@literate.ink/utilities";import{decode as n,encode as s}from"js-base64";var r=class{status;token;access_token=null;message=null;data;constructor(e){this.token=a(e,"x-token");const t=a(e,"content-type");if(t?.startsWith("application/json")||((n=e.content).startsWith("[")||n.startsWith("{"))&&(n.endsWith("]")||n.endsWith("}"))){const t=JSON.parse(e.content);this.status=t.code,this.data=t.data,this.message=t.message,"token"in t&&(this.token=t.token)}else this.status=Number.parseInt(a(e,"x-code"),10);var n}},o=class{url;headers;method;content;constructor(e){this.url=new URL(`https://api.ecoledirecte.com/v3${e}`),this.headers={"User-Agent":"Android EDMOBILE v7.0.1"}}setToken(e){return this.headers["X-Token"]=e,this}addVersionURL(){return this.url.searchParams.set("v","7.0.1"),this}setFormData(e){return this.method="POST",this.content=`data=${JSON.stringify(e)}`,this.headers["Content-Type"]="application/x-www-form-urlencoded",this}async send(t=e){const a=await t(this);return new r(a)}async sendRaw(t=e){return await t(this)}},i=class extends Error{constructor(){super("Bad credentials, no token found in response"),this.name="BadCredentials"}},d=class extends Error{constructor(){super("Bad double auth response"),this.name="BadDoubleAuth"}},c=class extends Error{constructor(){super("Double authentication required"),this.name="DoubleAuthRequired"}},l=class extends Error{constructor(){super("Invalid version, please open an issue at the 'LiterateInk/Pawdirecte' GitHub repository."),this.name="InvalidVersion"}},u=class extends Error{constructor(){super("Session token is required to do this action"),this.name="SessionTokenRequired"}},m=class extends Error{constructor(e,t){super(`Expected a value from the enum '${e}', but got '${t}'`),this.name="UnknownEnumValue"}},p={Student:"E"},w={PUNITION:"Punition",RETARD:"Retard",ABSENCE:"Absence",DISPENSE:"Dispense"},h={monday:"monday",tuesday:"tuesday",wednesay:"wednesday",thursday:"thursday",friday:"friday",saturday:"saturday",sunday:"sunday"},f={breakfast:"breakfast",lunch:"lunch",diner:"diner"},k={Grades:"Note",Document:"Doc",SchoolLife:"Viesco",Invoice:"Fac",Registration:"Inscr",Textbook:"FICHIER_CDT",Other:""},b=(e=>(e.Cloud="CLOUD",e.Homework="FICHIER_CDT",e.Attachement="PIECE_JOINTE",e.CantineMenu="FICHIER_MENU_RESTAURATION",e.Administrative="ADMINISTRATIF",e.Other="",e))(b||{}),y={Error:-1,Grade:0,Absent:1,Exempted:2,NotGraded:3,Waiting:4},D={Note:"Note",VieScolaire:"VieScolaire",ReunionPP:"ReunionPP",ReunionPPFamille:"ReunionPPFamille",Actualite:"Actualite",Messagerie:"Messagerie",DocumentFamille:"DocumentFamille",Document:"Document"},g={COURS:"COURS",PERMANENCE:"PERMANENCE",CONGE:"CONGE",EVENEMENT:"EVENEMENT",SANCTION:"SANCTION"},v={LIBRE:"LIBRE"},E=async(e,t)=>{if(!e.token)throw new u;const a=new o("/edforms.awp?verbe=list").addVersionURL().setToken(e.token).setFormData({idEntity:t.id,typeEntity:t.kind}),n=await a.send(e.fetcher);return e.token=n.token,n.data},A=e=>({id:e.id,studentId:e.idEleve,studentName:e.nomEleve,reason:e.motif,date:new Date(e.date),dateOfEvent:new Date(e.dateDeroulement),label:e.libelle,teacher:e.par,comment:e.commentaire,justified:e.justifie,justificationType:e.typeJustification,onlineJustification:e.justifieEd,subjectName:e.matiere,todo:e.aFaire,kind:e.typeElement,displayDate:""!==e.displayDate?e.displayDate:e.dateDeroulement.toLowerCase().replace("<br>"," ").replace("déroulement prévu ","")}),R=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/eleves/${t.id}/viescolaire.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);e.token=n.token;const s=n.data.sanctionsEncouragements,r=n.data.absencesRetards,i=n.data.dispenses;return{punishments:s.map(A),absences:r.map(A),exemptions:i.map(A)}},T=e=>{const t={monday:{breakfast:!1,lunch:"1"===e.params.repasmidi_1,diner:"1"===e.params.repassoir_1},tuesday:{breakfast:!1,lunch:"1"===e.params.repasmidi_2,diner:"1"===e.params.repassoir_2},wednesay:{breakfast:!1,lunch:"1"===e.params.repasmidi_3,diner:"1"===e.params.repassoir_3},thursday:{breakfast:!1,lunch:"1"===e.params.repasmidi_4,diner:"1"===e.params.repassoir_4},friday:{breakfast:!1,lunch:"1"===e.params.repasmidi_5,diner:"1"===e.params.repassoir_5},saturday:{breakfast:!1,lunch:"1"===e.params.repasmidi_6,diner:"1"===e.params.repassoir_6},sunday:{breakfast:!1,lunch:"1"===e.params.repasmidi_7,diner:"1"===e.params.repassoir_7}};return{badge:e.badge,diet:e.params.regime,meals:t}},C=async e=>{const t=e.modules.find((e=>"RESERVATIONS"===e.code)),a=e.modules.find((e=>"CANTINE_BARCODE"===e.code));return{reservation:t.enable??T(t),barcode:a.enable??(n=a,{badgeNumber:n.params.numeroBadge})};var n},N=e=>({id:e.id,name:e.libelle,date:new Date(e.date),kind:e.type,signatureRequired:e.signatureDemandee??!1,signature:e.signature??void 0}),F=async(e,t="")=>{if(!e.token)throw new u;const a=new o(`/elevesDocuments.awp?verbe=get&archive=${t}`).addVersionURL().setFormData({forceDownload:0}).setToken(e.token),n=await a.send(e.fetcher);return[...n.data.factures,...n.data.notes,...n.data.viescolaire,...n.data.administratifs,...n.data.inscriptions].map(N)},I=(e,t,a="")=>{const n=`/telechargement.awp?verbe=get&fichierId=${t}`;let s;switch(e){case"ADMINISTRATIF":s=n+a!==""?`archive=true&anneeArchive=${a}`:"";break;case"PIECE_JOINTE":s=n+a!==""?`anneeMessages=${a}`:"";break;default:s=`${n}&leTypeDeFichier=${e}`}return s},S=async(e,t,a,n="")=>{if(!e.token)throw new u;const s=I(t,a,n);return new o(s).addVersionURL().setFormData({forceDownload:0}).setToken(e.token).sendRaw(e.fetcher)},L=e=>{if(!e)return{kind:y.Error,points:0};switch(e.trim()){case"Disp":return{kind:y.Exempted,points:0};case"Abs":return{kind:y.Absent,points:0};case"NE":return{kind:y.NotGraded,points:0};case"EA":return{kind:y.Waiting,points:0};default:try{return{kind:y.Grade,points:Number(e.replaceAll(",","."))}}catch{return{kind:y.Error,points:0}}}},P=e=>({id:e.idCompetence,name:e.libelleCompetence,description:e.descriptif,value:Number(e.valeur)}),x=e=>({comment:e.devoir,average:L(e.moyenneClasse),isOptional:e.valeurisee,skills:e.elementsProgramme.map(P),coefficient:Number(e.coef),date:new Date(e.date),examType:e.typeDevoir,max:L(e.maxClasse),min:L(e.minClasse),outOf:e.noteSur.replaceAll(",","."),period:{id:e.codePeriode,name:""},subject:{id:e.codeMatiere,subSubjectId:e.codeSousMatiere,name:e.libelleMatiere},subjectFilePath:e.uncSujet,correctionFilePath:e.uncCorrige,value:L(e.valeur)}),M=e=>{const t={},a=e.parametrage.moyenneSur||20,n=e.parametrage.moyenneGenerale,s=e.parametrage.notePeriodeAnnuelle;for(const r of e.periodes)if(!1!==s||!0!==r.yearly){const e=r.ensembleMatieres.disciplines;t[r.idPeriode]={classAverage:L(r.ensembleMatieres.moyenneClasse),overallAverage:n?L(r.ensembleMatieres.moyenneGenerale):U(r),subjects:[]};for(const n of e)t[r.idPeriode].subjects.push({name:n.discipline,id:n.codeMatiere,childSubjectId:n.codeSousMatiere,isChildSubject:n.sousMatiere,color:"string",coefficient:Number(n.coef),classAverage:L(n.moyenneClasse?.replace(",",".")),maxAverage:L(n.moyenneMax?.replace(",",".")),minAverage:L(n.moyenneMin?.replace(",",".")),studentAverage:L(n.moyenne?.replace(",",".")),outOf:L(a.toString())})}return t};function U(e){let t=0,a=0;const n=e.ensembleMatieres.disciplines;for(const e of n)if(""!==e.moyenne){const n=L(e.moyenne?.replace(",",".")).points,s=0===e.coef?1:e.coef;t+=s,a+=n*s}return L((a/t).toString())}var _=e=>({id:e.idPeriode,startDate:new Date(e.dateDebut),endDate:new Date(e.dateFin),isEnded:e.cloture,councilDate:new Date(e.dateConseil),councilClassroom:e.salleConseil,councilStartHour:e.heureConseil,councilEndHour:e.heureFinConseil,isMockExam:e.examenBlanc,yearly:e.annuel,name:e.periode}),$=async(e,t,a)=>{if(!e.token)throw new u;const n=new o(`/eleves/${t.id}/notes.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({anneeScolaire:a}),s=await n.send(e.fetcher);return e.token=s.token,{grades:s.data.notes?.map(x),periods:s.data.periodes?.map(_).filter((e=>!(!1===s.data.parametrage.notePeriodeAnnuelle&&!0===e.yearly))),overview:M(s.data)}},j=e=>{const[t,a,n]=e.split("/").map(Number);return new Date(n,a-1,t)},V=e=>({authorName:e.auteur.nom,creationDate:j(e.dateCreation),startDate:j(e.dateDebut),endDate:j(e.dateFin),id:e.id,content:n(e.contenu),colorName:e.type}),O=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/E/${t.id}/timelineAccueilCommun.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);return e.token=n.token,n.data.postits.map(V)},G=e=>({id:e.id,subject:e.matiere,teacher:e.nomProf,exam:e.interrogation,done:e.aFaire.effectue,content:n(e.aFaire.contenu),createdDate:new Date(e.aFaire.donneLe),attachments:e.aFaire.documents.map(N)}),B=e=>({id:e.idDevoir,subject:e.matiere,isExam:e.interrogation,done:e.effectue,createdDate:new Date(e.donneLe)});var q=async(e,t,a)=>{if(!e.token)throw new u;const s=new o(`/Eleves/${t.id}/cahierdetexte/${a}.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),r=await s.send(e.fetcher);e.token=r.token;const i=r.data?.matieres.filter((e=>e.aFaire)).map(G),d=r.data?.matieres.map((e=>function(e,t){return{date:t,id:e.id,subject:e.matiere,teacher:e.nomProf,content:n(e.contenuDeSeance?.contenu??""),attachments:e.contenuDeSeance?.documents?.map(N)??[]}}(e,new Date(a)))).filter((e=>e.attachments.length>0||""!==e.content));return{homeworks:i,subjects:d}},H=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/Eleves/${t.id}/cahierdetexte.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);return e.token=n.token,Object.keys(n.data).map((e=>({date:new Date(e),homeworks:n.data[e].map(B)})))},W=async(e,t,a,n)=>{if(!e.token)throw new u;const s=new o(`/Eleves/${t.id}/cahierdetexte.awp?verbe=put`).addVersionURL().setToken(e.token).setFormData({idDevoirsEffectues:[n?a:null],idDevoirsNonEffectues:[n?null:a]});await s.send(e.fetcher)},J=e=>({id:e.id,type:e.mtype,read:e.read,subject:e.subject,date:new Date(e.date),sender:`${e.from.prenom} ${e.from.nom}`,canAnswer:e.canAnswer,content:e.content,files:e.files.map((e=>({id:e.id,name:e.libelle,type:e.type})))}),K=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/eleves/${t.id}/messages.awp?verbe=get&getAll=1`).addVersionURL().setToken(e.token).setFormData({anneeMessages:`${(new Date).getFullYear()}-${(new Date).getFullYear()+1}`}),n=await a.send(e.fetcher);return e.token=n.token,{canReply:n.data.parametrage.destAdmin||n.data.parametrage.destEleve||n.data.parametrage.destEspTravail||n.data.parametrage.destFamille||n.data.parametrage.destProf,chats:n.data.messages.received.map(J).sort(((e,t)=>e.date<t.date?1:e.date>t.date?-1:0))}},X=async(e,t,a)=>{if(!e.token)throw new u;const s=new o(`/eleves/${t.id}/messages/${a}.awp?verbe=get&mode=destinataire`).addVersionURL().setToken(e.token).setFormData({}),r=await s.send(e.fetcher);return e.token=r.token,{id:r.data.id,type:r.data.mtype,date:new Date(r.data.date),read:r.data.read,canAnswer:r.data.canAnswer,subject:r.data.subject,content:n(r.data.content),sender:`${r.data.from.prenom} ${r.data.from.nom}`,files:r.data.files.map((e=>({id:e.id,name:e.libelle,type:e.type})))}},Y=e=>({title:e.titre,description:e.soustitre,content:e.contenu,elementID:e.idElement,elementKind:e.typeElement,date:new Date(e.date)}),z=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/eleves/${t.id}/timeline.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);return e.token=n.token,n.data.map(Y)},Q=e=>({id:e.id,color:e.color,startDate:new Date(e.start_date),endDate:new Date(e.end_date),subjectName:e.matiere,subjectShortName:e.codeMatiere,room:e.salle,teacher:e.prof,kind:e.typeCours,cancelled:e.isAnnule,updated:e.isModifie,notes:e.text}),Z=async(e,t,a,n=a)=>{if(!e.token)throw new u;const s=new o(`/E/${t.id}/emploidutemps.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({dateDebut:a.toLocaleDateString("fr-CA"),dateFin:n.toLocaleDateString("fr-CA"),avecTrous:!1}),r=await s.send(e.fetcher);return e.token=r.token,r.data.map(Q).sort(((e,t)=>new Date(e.startDate).getTime()>new Date(t.startDate).getTime()))},ee=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/eleves/${t.id}/visios.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);return e.token=n.token,n.data},te=e=>({id:e.id,title:e.titre,description:e.description,summary:n(e.resume),cloud:e.cloud,discussion:e.discussion,agenda:e.agenda,isPublic:e.public,isOpen:e.ouvert,kind:e.type,isMember:e.estMembre,isAdmin:e.estAdmin,teacherRooms:e.salleDesProfs,createdBy:e.creePar,permissions:e.droitUtilisateur,nbMembers:e.nbMembres,colorEventAgenda:e.couleurEvenementAgenda,createdAt:e.creeLe}),ae=async(e,t)=>{if(!e.token)throw new u;const a=new o(`/E/${t.id}/espacestravail.awp?verbe=get`).addVersionURL().setToken(e.token).setFormData({}),n=await a.send(e.fetcher);return e.token=n.token,n.data?.map(te)??[]},ne=async e=>{if(!e.token)throw new u;const t=new o("/connexion/doubleauth.awp?verbe=get").addVersionURL().setToken(e.token).setFormData({}),a=await t.send(e.fetcher);if(!a.token)throw new i;return e.token=a.token,s=a.data,{question:n(s.question),answers:s.propositions.map(n)};var s},se=async(e,t)=>{if(!e.token)throw new u;const a=new o("/connexion/doubleauth.awp?verbe=post").addVersionURL().setToken(e.token).setFormData({choix:s(t)}),n=await a.send(e.fetcher);return e.token=n.token,e.double_auth=(e=>{if(null===e)throw new d;return{name:e.cn,value:e.cv}})(n.data),!0},re=e=>{if(e=String(e),!Object.values(p).includes(e))throw new m("AccountKind",e);return e},oe=e=>{const t=void 0!==e.profile.sexe&&null!==e.profile.sexe?e.profile.sexe:"Mme"===e.civilite?"F":"M";return{loginID:e.idLogin,id:e.id,userID:e.uid,username:e.identifiant,kind:re(e.typeCompte),ogecID:e.codeOgec,main:e.main,lastConnection:e.lastConnexion,firstName:e.prenom,lastName:e.nom,email:e.email,phone:e.profile.telPortable,schoolName:e.nomEtablissement,schoolUAI:e.profile.rneEtablissement,schoolLogoPath:e.logoEtablissement,schoolAgendaColor:e.couleurAgendaEtablissement,access_token:e.accessToken,socket_token:e.socketToken,gender:t,profilePictureURL:e.profile.photo,modules:e.modules,currentSchoolCycle:e.anneeScolaireCourante,class:{short:e.profile.classe.code,long:e.profile.classe.libelle}}},ie=e=>e?{cn:e.name,cv:e.value}:void 0,de=async(e,a=null)=>{let n,s;{const e=new o("/login.awp?gtk=1").addVersionURL(),a=await e.sendRaw();s=t(a);for(const e of s){const[t,a]=e.split("=");"GTK"===t&&(n=a)}if(!n)throw new Error("GTK cookie not found in response")}const r=new o("/login.awp").addVersionURL().setFormData(e);return r.headers["X-GTK"]=n,r.headers.Cookie=s.join("; "),a&&r.setToken(a),r},ce=async(e,t)=>{const a=ie(e.double_auth),n=await de({...a,fa:a&&[a],identifiant:e.username,uuid:e.device_uuid,isReLogin:!1,sesouvenirdemoi:!0,motdepasse:encodeURIComponent(t)},e.token);return ue(e,n)},le=async(e,t)=>{if(!e.token)throw new u;const a=await de({fa:[ie(e.double_auth)],identifiant:e.username,uuid:e.device_uuid,isReLogin:!0,motdepasse:"???",typeCompte:t,accesstoken:e.accessToken},e.token);return ue(e,a)},ue=async(e,t)=>{const a=await t.send(e.fetcher);switch(e.token=a.token,a.status){case 505:throw new i;case 517:throw new l;case 250:throw new c}return a.data.accounts.map(oe)},me=(e,t)=>{e.accessToken=t.access_token};export{p as AccountKind,w as AttendanceItemKind,i as BadCredentials,d as BadDoubleAuth,k as DocumentKind,c as DoubleAuthRequired,b as FileKind,y as GradeKind,l as InvalidVersion,f as ReservationMeals,h as ReservationWeekdays,u as SessionTokenRequired,D as TimelineItemKind,g as TimetableItemKind,m as UnknownEnumValue,v as WorkspaceItemKind,E as accountEdforms,I as buildPawdirecteFileDownloadUrl,se as checkDoubleAuth,S as getFile,ne as initDoubleAuth,ce as login,X as readMessage,le as refresh,me as setAccessToken,W as setHomeworkState,R as studentAttendance,C as studentCantine,H as studentComingHomeworks,F as studentDocuments,$ as studentGrades,O as studentHomepageTimeline,q as studentHomeworks,K as studentReceivedMessages,z as studentTimeline,Z as studentTimetable,ee as studentVisios,ae as studentWorkspace};//# sourceMappingURL=index.mjs.map